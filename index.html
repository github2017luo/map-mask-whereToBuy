<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>map-mask-whereToBuy</title>

    <!-- ğŸ—ã€–JavaScript - Map Marker CDN Links - Leafletã€—href=https://leafletjs.com/download.html -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>

    <!-- ğŸ—ã€–JavaScript - Map Marker CDN Links - Leaflet Plugin - MarkerClusterã€—href=https://unpkg.com/browse/leaflet.markercluster@1.4.1/dist/ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster-src.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
        }
        .bdb { border-bottom: 1px solid #AAA;}
    </style>

</head>

<body>
    <div id="map"></div>
</body>

<script>

    // â˜›TODO: åœ°åœ–è¨­ç½®
    let lat = 0;
    let lon = 0;
    const mapFn = function (lat, lon) {
        // â˜›TODO: é‡æ–°è¼‰å…¥mapæ™‚ï¼Œæ¸…é™¤ lat, lon è³‡æ–™
        if (this.map != null) {
            this.map._leaflet_id = null;
        }

        // â˜›TODO: å•Ÿç”¨ Leaflet å¤–æ›
        var map = L.map("map").setView([lat, lon], 16);

        // â˜›TODO: è¼‰å…¥ openstreetmap åœ°åœ–
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // â˜›TODO: è‡ªå®šIcon
        // ğŸ›ˆ å¸¸äººå’Œå°å­©å­˜é‡
        var greenIcon = new L.Icon({
            iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // ğŸ›ˆ å¸¸äººæˆ–å°å­©æœ‰å­˜é‡
        var yellowIcon = new L.Icon({
            iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // ğŸ›ˆ å¸¸äººæˆ–å°å­©ç„¡å­˜é‡
        var grayIcon = new L.Icon({
            iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gray.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // â˜›TODO: å•Ÿç”¨ MarkerCluster å¤–æ›
        var markers = new L.MarkerClusterGroup().addTo(map);

        // â˜›TODO: Ajax è³‡æ–™ä¸²æ¥
        const ajaxFn = function () {
            var xhr = new XMLHttpRequest();

            xhr.open('GET', "https://raw.githubusercontent.com/kiang/pharmacies/master/json/points.json");

            xhr.send();

            xhr.onload = function () {
                // ğŸ›ˆ æ¯æ¬¡loadingéƒ½æœƒåˆªé™¤ä¹‹å‰mapçš„è³‡æ–™
                markers.clearLayers();

                // ğŸ›ˆ å°‡å®ƒè½‰æˆç‰©ä»¶é™£åˆ—çš„JSONæ ¼å¼ã€å‚™è¨»ï¼šç¶“ç”±ajaxæ’ˆå›ä¾†çš„è³‡æ–™ä¸€å®šæ˜¯string, æ•…ä¸€å®šè¦ç”¨JSON.parseå†è½‰æˆJSONæ ¼å¼ã€
                // ğŸ›ˆ è®€å–è©²jsonçš„features
                var data = JSON.parse(xhr.responseText).features;

                // ğŸ›ˆ ç”¨è¿´åœˆæŠŠè³‡æ–™å…¨éƒ¨åˆ—å‡ºä¾†
                for (let i = 0; data.length > i; i++) {

                    // ğŸ›ˆ è¨­ç«‹åˆ¤æ–·å¼ã€‚å‡å¦‚å£ç½©ï¼Œæœ‰åº«å­˜ç‚ºç¶ æ¨™ï¼Œç„¡åº«å­˜ç‚ºç´…æ¨™ã€‚
                    var mask;
                    if (data[i].properties.mask_adult == 0 && data[i].properties.mask_child == 0) {
                        // mask = redIcon;
                        mask = grayIcon;
                    } else if (data[i].properties.mask_adult == 0 || data[i].properties.mask_child == 0) {
                        mask = yellowIcon;
                    } else {
                        mask = greenIcon;
                    }

                    // ğŸ›ˆ åœ¨è©²åœ–å±¤ä¸Šï¼Œåˆ†åˆ¥åŠ ä¸Šmarkerã€‚
                    // ğŸ›ˆ data[i].geometry.coordinates[1] ç‚º è©²JSONæª”çš„ latitude(ç·¯åº¦)
                    // ğŸ›ˆ data[i].geometry.coordinates[0] ç‚º è©²JSONæª”çš„ longitude(ç¶“åº¦)
                    // ğŸ›ˆ icon è¨­ç«‹è®Šæ•¸ mask
                    // ğŸ›ˆ .bindPopup(data[i].properties.name) å½ˆè·³è¦–çª—ä¸Š ç¶å®šè—¥å±€åç¨±
                    // ğŸ›ˆ é€™è£¡"\"ç‚ºjavascriptç‚ºæ›è¡Œ
                    markers.addLayer(L.marker([data[i].geometry.coordinates[1], data[i].geometry.coordinates[0]], { icon: mask })
                        .bindPopup(
                            '<div class="bdb">\
                            <h1>'+ data[i].properties.name + '</h1>\
                            <h3> <span>é›»è©±ï¼š</span> <a href="tel:'+ data[i].properties.phone + '">' + data[i].properties.phone + '</a></h3>\
                            <h3> <span>åœ°å€ï¼š</span>'+ data[i].properties.address + '</h3>\
                            <h3> <span>æ›´æ–°æ™‚é–“ï¼š</span>'+ data[i].properties.updated + '</h3>\
                        </div>\
                        <p>æˆäººå£ç½©æ•¸é‡ï¼š'+ data[i].properties.mask_adult + '</p>\
                        <p>å°å­©å£ç½©æ•¸é‡ï¼š'+ data[i].properties.mask_child + '</p>'
                        ));
                }
            };
        };

        // â˜›TODO: ä¸€é€²ç•«é¢å°±å…ˆload ajaxè³‡æ–™
        ajaxFn();

        // â˜›TODO: å®šæ™‚å™¨ è³‡æ–™ä¸²æ¥
        // ğŸ›ˆ æ¸¬è©¦60ç§’ loadä¸€æ¬¡
        const intervalID = window.setInterval(ajaxFn, 60000);

        map.addLayer(markers);
    }

    // â˜›TODO: é è¨­åœ°åœ–ç¶“ç·¯åº¦
    mapFn(22.604799, 120.2976256);


    // â˜›TODO: å•Ÿç”¨ GPS å®šä½
    function success(position) {
        lat = position.coords.latitude;
        lon = position.coords.longitude;
        mapFn(lat, lon);
    };

    function error() { alert("Unable to retrieve your location") };

    navigator.geolocation.getCurrentPosition(success, error);
</script>

</html>